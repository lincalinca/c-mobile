import React, { useEffect } from 'react';
import { View } from 'react-native';
import Svg, { Path } from 'react-native-svg';
import Animated, {
  useSharedValue,
  useAnimatedProps,
  withTiming,
  withDelay,
  Easing,
} from 'react-native-reanimated';

// AnimatedPath allows us to animate path properties via useAnimatedProps
const AnimatedPath = Animated.createAnimatedComponent(Path);

// Module-scope constants: extracted path data for each letter (CRESCENDER)
// This avoids serialisation errors by keeping data outside render scope
const LOGO_PATHS: readonly { d: string; fill: string }[] = [
  // C (first)
  { d: 'M20.832 62.16C18.08 62.16 15.616 61.552 13.44 60.336C11.264 59.12 9.536 57.456 8.256 55.344C6.976 53.232 6.336 50.864 6.336 48.24C6.336 45.616 6.976 43.248 8.256 41.136C9.536 39.024 11.264 37.36 13.44 36.144C15.616 34.928 18.08 34.32 20.832 34.32C23.136 34.32 25.248 34.768 27.168 35.664C29.152 36.56 30.784 37.776 32.064 39.312L29.76 41.04C27.584 38.48 24.608 37.2 20.832 37.2C17.504 37.2 14.72 38.256 12.48 40.368C10.304 42.416 9.216 45.04 9.216 48.24C9.216 51.376 10.304 54 12.48 56.112C14.72 58.224 17.504 59.28 20.832 59.28C24.608 59.28 27.584 58 29.76 55.44L32.064 57.168C30.784 58.704 29.152 59.92 27.168 60.816C25.248 61.712 23.136 62.16 20.832 62.16ZM20.832 68.496C16.928 68.496 13.408 67.6 10.272 65.808C7.136 64.016 4.64 61.584 2.784 58.512C0.928 55.44 0 52.016 0 48.24C0 44.4 0.928 40.976 2.784 37.968C4.64 34.896 7.136 32.464 10.272 30.672C13.408 28.88 16.928 27.984 20.832 27.984C24.16 27.984 27.232 28.656 30.048 30C32.864 31.344 35.2 33.136 37.056 35.376L34.848 37.104C33.248 35.184 31.232 33.68 28.8 32.592C26.368 31.44 23.712 30.864 20.832 30.864C17.44 30.864 14.368 31.632 11.616 33.168C8.928 34.704 6.784 36.784 5.184 39.408C3.648 41.968 2.88 44.912 2.88 48.24C2.88 51.504 3.648 54.448 5.184 57.072C6.784 59.696 8.928 61.776 11.616 63.312C14.368 64.848 17.44 65.616 20.832 65.616C23.712 65.616 26.368 65.072 28.8 63.984C31.232 62.832 33.248 61.296 34.848 59.376L37.056 61.104C35.2 63.344 32.864 65.136 30.048 66.48C27.232 67.824 24.16 68.496 20.832 68.496Z', fill: '#FFD700' },
  // R
  { d: 'M57.7078 67.536V25.728H74.0358C77.4331 25.7973 80.3451 26.976 82.7718 29.264C85.1984 31.4827 86.4118 34.568 86.4118 38.52C86.4118 41.5707 85.6491 44.136 84.1237 46.216C82.6677 48.296 80.7611 49.752 78.4038 50.584L85.6838 67.536H82.2518L75.3878 51.208C74.8331 51.2773 74.3824 51.312 74.0358 51.312H71.3318L78.1958 67.536H74.7638L67.8997 51.312H60.8278V67.536H57.7078ZM50.8438 67.536V25.728H53.9638V67.536H50.8438ZM73.8278 28.848H60.8278V32.592H74.0358C75.6998 32.6613 77.0171 33.2507 77.9878 34.36C79.0278 35.4 79.5478 36.7867 79.5478 38.52C79.5478 40.2533 79.0278 41.6747 77.9878 42.784C76.9478 43.8933 75.6304 44.448 74.0358 44.448H60.8278V48.192H73.8278C76.4624 48.192 78.6811 47.3947 80.4837 45.8C82.3558 44.136 83.2918 41.7093 83.2918 38.52C83.2918 35.3307 82.3558 32.9387 80.4837 31.344C78.6811 29.68 76.4624 28.848 73.8278 28.848ZM73.8278 35.712H60.8278V41.328H73.8278C74.5904 41.328 75.2144 41.12 75.6998 40.704C76.1851 40.2187 76.4277 39.4907 76.4277 38.52C76.4277 37.5493 76.1851 36.856 75.6998 36.44C75.2144 35.9547 74.5904 35.712 73.8278 35.712Z', fill: '#FFD700' },
  // E (first)
  { d: 'M108.695 67.536V22.512H135.463V25.872H112.055V29.904H135.463V33.264H112.055V39.648H131.879V43.008H112.055V47.04H131.879V50.4H112.055V56.784H135.463V60.144H112.055V64.176H135.463V67.536H108.695ZM101.303 67.536V22.512H104.663V67.536H101.303Z', fill: '#FFD700' },
  // S
  { d: 'M168.031 60.816C164.831 60.816 162.191 60.216 160.111 59.016C158.111 57.816 156.991 56.256 156.751 54.336L160.351 53.856C160.431 54.896 161.151 55.736 162.511 56.376C163.871 56.936 165.711 57.216 168.031 57.216C173.151 57.216 175.711 56.096 175.711 53.856C175.711 52.896 175.191 52.056 174.151 51.336C173.111 50.536 171.231 49.736 168.511 48.936L162.391 47.136C158.631 46.016 155.471 44.336 152.911 42.096C150.431 39.856 149.191 36.856 149.191 33.096C149.191 30.216 149.991 27.656 151.591 25.416C153.271 23.176 155.551 21.416 158.431 20.136C161.311 18.776 164.511 18.096 168.031 18.096C173.151 18.096 177.431 19.336 180.871 21.816C184.311 24.296 186.271 27.496 186.751 31.416L183.151 31.776C182.831 28.736 181.271 26.296 178.471 24.456C175.751 22.616 172.271 21.696 168.031 21.696C163.631 21.696 159.991 22.776 157.111 24.936C154.231 27.096 152.791 29.816 152.791 33.096C152.791 36.056 153.751 38.336 155.671 39.936C157.591 41.536 160.311 42.856 163.831 43.896L170.431 45.816C176.351 47.576 179.311 50.216 179.311 53.736C179.311 55.976 178.271 57.736 176.191 59.016C174.191 60.216 171.471 60.816 168.031 60.816ZM168.031 68.736C162.751 68.736 158.351 67.496 154.831 65.016C151.391 62.536 149.431 59.336 148.951 55.416L152.551 54.936C152.951 57.976 154.551 60.456 157.351 62.376C160.151 64.216 163.711 65.136 168.031 65.136C172.671 65.136 176.431 64.096 179.311 62.016C182.191 59.856 183.631 56.936 183.631 53.256C183.631 50.296 182.711 47.896 180.871 46.056C179.031 44.216 176.351 42.856 172.831 41.976L165.511 40.056C162.791 39.336 160.711 38.456 159.271 37.416C157.831 36.296 157.111 34.856 157.111 33.096C157.111 30.936 158.111 29.216 160.111 27.936C162.191 26.656 164.831 26.016 168.031 26.016C170.991 26.016 173.471 26.616 175.471 27.816C177.471 28.936 178.591 30.416 178.831 32.256L175.351 32.736C174.951 30.656 172.511 29.616 168.031 29.616C165.791 29.616 163.991 29.936 162.631 30.576C161.351 31.136 160.711 31.976 160.711 33.096C160.711 33.816 161.151 34.456 162.031 35.016C162.911 35.496 164.831 36.176 167.791 37.056L174.151 38.856C178.311 40.056 181.511 41.816 183.751 44.136C186.071 46.456 187.231 49.496 187.231 53.256C187.231 58.056 185.431 61.856 181.831 64.656C178.311 67.376 173.711 68.736 168.031 68.736Z', fill: '#FFD700' },
  // C (second)
  { d: 'M230.835 60.368C227.166 60.368 223.881 59.5573 220.979 57.936C218.078 56.3147 215.774 54.096 214.067 51.28C212.361 48.464 211.507 45.3067 211.507 41.808C211.507 38.3093 212.361 35.152 214.067 32.336C215.774 29.52 218.078 27.3013 220.979 25.68C223.881 24.0587 227.166 23.248 230.835 23.248C233.907 23.248 236.723 23.8453 239.283 25.04C241.929 26.2347 244.105 27.856 245.811 29.904L242.739 32.208C239.838 28.7947 235.87 27.088 230.835 27.088C226.398 27.088 222.686 28.496 219.699 31.312C216.798 34.0427 215.347 37.5413 215.347 41.808C215.347 45.9893 216.798 49.488 219.699 52.304C222.686 55.12 226.398 56.528 230.835 56.528C235.87 56.528 239.838 54.8213 242.739 51.408L245.811 53.712C244.105 55.76 241.929 57.3813 239.283 58.576C236.723 59.7707 233.907 60.368 230.835 60.368ZM230.835 68.816C225.63 68.816 220.937 67.6213 216.755 65.232C212.574 62.8427 209.246 59.6 206.771 55.504C204.297 51.408 203.059 46.8427 203.059 41.808C203.059 36.688 204.297 32.1227 206.771 28.112C209.246 24.016 212.574 20.7733 216.755 18.384C220.937 15.9947 225.63 14.8 230.835 14.8C235.273 14.8 239.369 15.696 243.123 17.488C246.878 19.28 249.993 21.6693 252.467 24.656L249.523 26.96C247.39 24.4 244.702 22.3947 241.459 20.944C238.217 19.408 234.675 18.64 230.835 18.64C226.313 18.64 222.217 19.664 218.547 21.712C214.963 23.76 212.105 26.5333 209.971 30.032C207.923 33.4453 206.899 37.3707 206.899 41.808C206.899 46.16 207.923 50.0853 209.971 53.584C212.105 57.0827 214.963 59.856 218.547 61.904C222.217 63.952 226.313 64.976 230.835 64.976C234.675 64.976 238.217 64.2507 241.459 62.8C244.702 61.264 247.39 59.216 249.523 56.656L252.467 58.96C249.993 61.9467 246.878 64.336 243.123 66.128C239.369 67.92 235.273 68.816 230.835 68.816Z', fill: '#FFD700' },
  // E (second)
  { d: 'M279.72 67.536V12.864H312.224V16.944H283.8V21.84H312.224V25.92H283.8V33.672H307.872V37.752H283.8V42.648H307.872V46.728H283.8V54.48H312.224V58.56H283.8V63.456H312.224V67.536H279.72ZM270.744 67.536V12.864H274.824V67.536H270.744Z', fill: '#FFD700' },
  // N
  { d: 'M329.991 67.536V9.648H334.311V67.536H329.991ZM378.087 67.536V9.648H382.407V67.536H378.087ZM368.583 51.408L343.815 16.992V25.776L368.583 60.192V51.408ZM339.495 67.536V9.648H343.815L368.583 44.064V9.648H372.903V67.536H368.583L343.815 33.12V67.536H339.495Z', fill: '#FFD700' },
  // D
  { d: 'M414.407 67.536V6.432H429.607C435.991 6.53333 441.615 7.90133 446.479 10.536C451.343 13.1707 455.143 16.768 457.879 21.328C460.716 25.888 462.135 31.1067 462.135 36.984C462.135 42.8613 460.716 48.1307 457.879 52.792C455.143 57.352 451.292 60.9493 446.327 63.584C441.463 66.2187 435.89 67.536 429.607 67.536H414.407ZM404.375 67.536V6.432H408.935V67.536H404.375ZM429.151 10.992H418.967V16.464H429.607C436.295 16.5653 441.716 18.4907 445.871 22.24C450.026 25.9893 452.103 30.904 452.103 36.984C452.103 43.1653 449.975 48.1307 445.719 51.88C441.564 55.6293 436.194 57.504 429.607 57.504H418.967V62.976H429.151C434.826 62.976 439.791 61.912 444.047 59.784C448.303 57.5547 451.596 54.464 453.927 50.512C456.359 46.56 457.575 42.0507 457.575 36.984C457.575 31.816 456.359 27.3067 453.927 23.456C451.596 19.504 448.303 16.464 444.047 14.336C439.791 12.1067 434.826 10.992 429.151 10.992ZM429.151 21.024H418.967V52.944H429.151C434.826 52.944 439.284 51.5253 442.527 48.688C445.871 45.8507 447.543 41.9493 447.543 36.984C447.543 32.0187 445.871 28.1173 442.527 25.28C439.284 22.4427 434.826 21.024 429.151 21.024Z', fill: '#FFD700' },
  // E (third)
  { d: 'M494.325 67.536V3.216H532.565V8.016H499.125V13.776H532.565V18.576H499.125V27.696H527.445V32.496H499.125V38.256H527.445V43.056H499.125V52.176H532.565V56.976H499.125V62.736H532.565V67.536H494.325ZM483.765 67.536V3.216H488.565V67.536H483.765Z', fill: '#FFD700' },
  // R (last)
  { d: 'M564.498 67.536V0H590.874C596.362 0.111999 601.066 2.016 604.986 5.712C608.906 9.296 610.866 14.28 610.866 20.664C610.866 25.592 609.634 29.736 607.17 33.096C604.818 36.456 601.738 38.808 597.93 40.152L609.69 67.536H604.146L593.058 41.16C592.162 41.272 591.434 41.328 590.874 41.328H586.506L597.594 67.536H592.05L580.962 41.328H569.538V67.536H564.498ZM553.41 67.536V0H558.45V67.536H553.41ZM590.538 5.04H569.538V11.088H590.874C593.562 11.2 595.69 12.152 597.258 13.944C598.938 15.624 599.778 17.864 599.778 20.664C599.778 23.464 598.938 25.76 597.258 27.552C595.578 29.344 593.45 30.24 590.874 30.24H569.538V36.288H590.538C594.794 36.288 598.378 35 601.29 32.424C604.314 29.736 605.826 25.816 605.826 20.664C605.826 15.512 604.314 11.648 601.29 9.072C598.378 6.384 594.794 5.04 590.538 5.04ZM590.538 16.128H569.538V25.2H590.538C591.77 25.2 592.778 24.864 593.562 24.192C594.346 23.408 594.738 22.232 594.738 20.664C594.738 19.096 594.346 17.976 593.562 17.304C592.778 16.52 591.77 16.128 590.538 16.128Z', fill: '#FFD700' },
] as const;

// Animation configuration constants (module scope for worklet safety)
const LETTER_COUNT = LOGO_PATHS.length;
const STAGGER_DELAY_MS = 60; // Delay between each letter's animation start
const ANIMATION_DURATION_MS = 400; // Duration of each letter's nudge
const NUDGE_DISTANCE_PX = 6; // Subtle horizontal nudge in pixels

// Original SVG dimensions
const SVG_WIDTH = 611;
const SVG_HEIGHT = 69;

interface AnimatedLetterProps {
  pathData: string;
  fill: string;
  index: number;
  phase: Animated.SharedValue<number>;
}

/**
 * Individual animated letter component.
 * Uses useAnimatedProps to animate translateX based on a shared phase value.
 * The stagger offset is calculated from the letter index.
 */
const AnimatedLetter = React.memo(({ pathData, fill, index, phase }: AnimatedLetterProps) => {
  // useAnimatedProps creates animated props that can be applied to SVG elements.
  // Only primitives and shared values are referenced in the worklet to avoid serialisation errors.
  const animatedProps = useAnimatedProps(() => {
    'worklet';
    // Calculate staggered progress for this letter (0 to 1)
    // Each letter starts slightly after the previous one
    const staggerOffset = index / LETTER_COUNT;
    const localProgress = Math.max(0, Math.min(1, (phase.value - staggerOffset) * 2));

    // Ease-out curve for smooth deceleration
    const eased = 1 - Math.pow(1 - localProgress, 3);

    // Start offset, animate to 0 (nudge from left to rest position)
    const translateX = NUDGE_DISTANCE_PX * (1 - eased);

    return {
      transform: [{ translateX }],
    };
  }, [index]);

  return (
    <AnimatedPath
      d={pathData}
      fill={fill}
      animatedProps={animatedProps}
    />
  );
});

AnimatedLetter.displayName = 'AnimatedLetter';

export interface AnimatedLogoProps {
  /** Optional width override (height scales proportionally) */
  width?: number;
  /** Optional height override (width scales proportionally) */
  height?: number;
  /** Whether to run the animation on mount. Defaults to true. */
  animate?: boolean;
}

/**
 * AnimatedLogo - Crescender logo with subtle sequential letter nudge animation.
 *
 * Uses react-native-reanimated shared values and useAnimatedProps for
 * performant, worklet-based animation without serialisation issues.
 *
 * @example
 * <AnimatedLogo width={300} />
 */
export const AnimatedLogo: React.FC<AnimatedLogoProps> = ({
  width,
  height,
  animate = true,
}) => {
  // Single shared value drives all letter animations (phase: 0 â†’ 1)
  const phase = useSharedValue(0);

  // Calculate dimensions maintaining aspect ratio
  const aspectRatio = SVG_WIDTH / SVG_HEIGHT;
  const finalWidth = width ?? (height ? height * aspectRatio : SVG_WIDTH);
  const finalHeight = height ?? (width ? width / aspectRatio : SVG_HEIGHT);

  useEffect(() => {
    if (!animate) {
      phase.value = 1; // Jump to end state if animation disabled
      return;
    }

    // Reset and animate phase from 0 to 1 on mount
    phase.value = 0;
    phase.value = withDelay(
      100, // Small initial delay for mount transition
      withTiming(1, {
        duration: ANIMATION_DURATION_MS + STAGGER_DELAY_MS * LETTER_COUNT,
        easing: Easing.out(Easing.cubic),
      })
    );
  }, [animate, phase]);

  return (
    <View>
      <Svg
        width={finalWidth}
        height={finalHeight}
        viewBox={`0 0 ${SVG_WIDTH} ${SVG_HEIGHT}`}
      >
        {LOGO_PATHS.map((path, index) => (
          <AnimatedLetter
            key={index}
            pathData={path.d}
            fill={path.fill}
            index={index}
            phase={phase}
          />
        ))}
      </Svg>
    </View>
  );
};

export default AnimatedLogo;

